<h2>Mensageiro</h2>

<hr>

<h3>Criar Template</h3>

<input id="title" placeholder="Título">
<input id="subject" placeholder="Assunto">
<br><br>
<textarea id="body" placeholder="Corpo do email (ex: Olá {{nome}})"></textarea>
<br>

<button onclick="createTemplate()">Salvar template</button>
<button onclick="loadTemplates()">Atualizar templates</button>

<hr>

<h3>Meus templates</h3>
<ul id="templatesList"></ul>

<hr>

<h3>Enviar e-mail</h3>

<label>Template:</label>
<select id="templateSelect"></select>

<br><br>

<label>Para (usuário):</label>
<select id="userSelect"></select>

<br><br>

<label>Nome (para {{nome}}):</label>
<input id="nomeVar" placeholder="Ex: Carlos">

<br><br>

<button onclick="sendEmail()">Enviar</button>

<hr>

<h3>Histórico (enviados/recebidos)</h3>
<button onclick="loadEmails()">Atualizar histórico</button>
<ul id="emailsList"></ul>

<hr>

<h3>Caixa de entrada (recebidos)</h3>
<button onclick="loadInbox()">Atualizar caixa de entrada</button>
<ul id="inboxList"></ul>

<script>
const token = localStorage.getItem("token");

if(!token){
  window.location = "/";
}

function authHeaders(){
  return {
    "Content-Type":"application/json",
    "Authorization":"Bearer " + token
  };
}

function getUserIdFromToken(){
  // pega o payload do JWT e lê o "sub"
  const payload = JSON.parse(atob(token.split('.')[1]));
  return parseInt(payload.sub);
}

function createTemplate(){
  fetch("/templates", {
    method:"POST",
    headers: authHeaders(),
    body: JSON.stringify({
      title: title.value,
      subject: subject.value,
      body: body.value
    })
  })
  .then(res => res.json().then(data => ({ ok: res.ok, data })))
  .then(({ ok, data }) => {
    if(ok){
      alert("Template criado com sucesso!");

      // limpa campos
      title.value = "";
      subject.value = "";
      body.value = "";

      loadTemplates();
    }else{
      alert(data.msg || "Erro ao criar template");
    }
  });
}

function fillTemplateSelect(templates){
  templateSelect.innerHTML = "";
  templates.forEach(t => {
    const opt = document.createElement("option");
    opt.value = t.id;
    opt.textContent = `#${t.id} - ${t.title}`;
    templateSelect.appendChild(opt);
  });
}

function loadTemplates(){
  fetch("/templates", { headers: authHeaders() })
    .then(res => res.json().then(data => ({ ok: res.ok, data })))
    .then(({ ok, data }) => {
      if(!ok){
        alert(data.msg || "Erro ao listar templates");
        return;
      }

      templatesList.innerHTML = "";

      data.forEach(t => {
        const li = document.createElement("li");
        li.textContent = `#${t.id} - ${t.title} | ${t.subject}`;
        templatesList.appendChild(li);
      });

      fillTemplateSelect(data);
    });
}

function loadUsers(){
  fetch("/users", { headers: authHeaders() })
    .then(res => res.json().then(data => ({ ok: res.ok, data })))
    .then(({ ok, data }) => {
      if(!ok){
        alert(data.msg || "Erro ao listar usuários");
        return;
      }

      userSelect.innerHTML = "";
      data.forEach(u => {
        const opt = document.createElement("option");
        opt.value = u.id;
        opt.textContent = `${u.email} (id ${u.id})`;
        userSelect.appendChild(opt);
      });
    });
}

function sendEmail(){
  if(!templateSelect.value){
    alert("Crie ou selecione um template primeiro.");
    return;
  }
  if(!userSelect.value){
    alert("Cadastre outro usuário para enviar.");
    return;
  }

  fetch("/send-email", {
    method: "POST",
    headers: authHeaders(),
    body: JSON.stringify({
      template_id: Number(templateSelect.value),
      receiver_id: Number(userSelect.value),
      nome: nomeVar.value
    })
  })
  .then(res => res.json().then(data => ({ ok: res.ok, data })))
  .then(({ ok, data }) => {
    if(ok){
      alert("Enviado (registrado no sistema)!");
      nomeVar.value = "";

      loadEmails();
      loadInbox(); // atualiza a caixa de entrada também
    }else{
      alert(data.msg || "Erro ao enviar");
    }
  });
}

function loadEmails(){
  fetch("/emails", { headers: authHeaders() })
    .then(res => res.json().then(data => ({ ok: res.ok, data })))
    .then(({ ok, data }) => {
      if(!ok){
        alert(data.msg || "Erro ao carregar histórico");
        return;
      }

      emailsList.innerHTML = "";

      data.forEach(e => {
        const li = document.createElement("li");
        li.textContent = `#${e.id} | de ${e.sender_id} para ${e.receiver_id} | ${e.subject} | ${e.created_at}`;
        emailsList.appendChild(li);
      });
    });
}

function loadInbox(){
  const myId = getUserIdFromToken();

  fetch("/emails", { headers: authHeaders() })
    .then(res => res.json().then(data => ({ ok: res.ok, data })))
    .then(({ ok, data }) => {
      if(!ok){
        alert(data.msg || "Erro ao carregar caixa de entrada");
        return;
      }

      inboxList.innerHTML = "";

      data.forEach(e => {
        // somente recebidos por mim
        if(e.receiver_id == myId){
          const li = document.createElement("li");

          li.innerHTML =
            "<b>Assunto:</b> " + e.subject +
            "<br><b>Mensagem:</b> " + e.body +
            "<br><small>Recebido em: " + e.created_at + "</small>";

          inboxList.appendChild(li);
        }
      });

      if(inboxList.innerHTML.trim() === ""){
        inboxList.innerHTML = "<li>Nenhum e-mail recebido ainda.</li>";
      }
    });
}

// carrega tudo ao abrir
loadUsers();
loadTemplates();
loadEmails();
loadInbox();
</script>